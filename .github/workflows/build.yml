name: Build/Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    permissions:
      contents: write
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win32
            arch: x64
          - os: macos-latest # ARM64
            platform: darwin
            arch: arm64
          - os: macos-15-intel # Intel x64 (macos-15-intel å¯èƒ½ä¸å­˜åœ¨)
            platform: darwin
            arch: x64

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4

      - name: Checkout inklip-base-go
        uses: actions/checkout@v4
        with:
          repository: caleb-meteor/inklip-base-go
          token: ${{ secrets.GH_PAT }}
          path: inklip-base-go

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Download Go dependencies
        shell: bash
        run: |
          cd inklip-base-go
          go mod download

      - name: Build inklip-base-go
        shell: bash
        run: |
          cd inklip-base-go
          # -tags sqlite_fts5 å¯ç”¨ SQLite FTS5 å…¨æ–‡æ£€ç´¢ï¼ˆè§†é¢‘/å­—å¹•æœç´¢ä¾èµ–ï¼‰
          if [ "${{ matrix.platform }}" = "win32" ]; then
            echo "ðŸ”¨ æž„å»º Windows ç‰ˆæœ¬..."
            mkdir -p dist/win32-x64
            GOOS=windows GOARCH=amd64 go build -tags sqlite_fts5 -ldflags "-s -w" -o dist/win32-x64/inklip-base.exe .
          elif [ "${{ matrix.platform }}" = "darwin" ] && [ "${{ matrix.arch }}" = "x64" ]; then
            echo "ðŸ”¨ æž„å»º Mac Intel ç‰ˆæœ¬..."
            mkdir -p dist/darwin-x64
            GOOS=darwin GOARCH=amd64 go build -tags sqlite_fts5 -ldflags "-s -w" -o dist/darwin-x64/inklip-base .
          elif [ "${{ matrix.platform }}" = "darwin" ] && [ "${{ matrix.arch }}" = "arm64" ]; then
            echo "ðŸ”¨ æž„å»º Mac ARM ç‰ˆæœ¬..."
            mkdir -p dist/darwin-arm64
            GOOS=darwin GOARCH=arm64 go build -tags sqlite_fts5 -ldflags "-s -w" -o dist/darwin-arm64/inklip-base .
          fi

      - name: Download and extract platform resources
        shell: bash
        run: |
          mkdir -p resources/${{ matrix.platform }}-${{ matrix.arch }}
          curl -L https://oss-inklip.caleb.center/resources/${{ matrix.platform }}-${{ matrix.arch }}.zip -o resources.zip
          unzip -o resources.zip -d resources/
          rm resources.zip

      - name: Copy inklip-base to resources
        shell: bash
        run: |
          mkdir -p resources/${{ matrix.platform }}-${{ matrix.arch }}/inklip-base
          if [ "${{ matrix.platform }}" = "win32" ]; then
            if [ ! -f "inklip-base-go/dist/win32-x64/inklip-base.exe" ]; then
              echo "::error::inklip-base.exe not found!"
              exit 1
            fi
            cp inklip-base-go/dist/win32-x64/inklip-base.exe resources/${{ matrix.platform }}-${{ matrix.arch }}/inklip-base/
            echo "âœ… inklip-base.exe å·²å¤åˆ¶åˆ° resources/${{ matrix.platform }}-${{ matrix.arch }}/inklip-base/"
          elif [ "${{ matrix.platform }}" = "darwin" ] && [ "${{ matrix.arch }}" = "x64" ]; then
            if [ ! -f "inklip-base-go/dist/darwin-x64/inklip-base" ]; then
              echo "::error::inklip-base (darwin-x64) not found!"
              exit 1
            fi
            cp inklip-base-go/dist/darwin-x64/inklip-base resources/${{ matrix.platform }}-${{ matrix.arch }}/inklip-base/
            chmod +x resources/${{ matrix.platform }}-${{ matrix.arch }}/inklip-base/inklip-base
            echo "âœ… inklip-base (darwin-x64) å·²å¤åˆ¶åˆ° resources/${{ matrix.platform }}-${{ matrix.arch }}/inklip-base/"
          elif [ "${{ matrix.platform }}" = "darwin" ] && [ "${{ matrix.arch }}" = "arm64" ]; then
            if [ ! -f "inklip-base-go/dist/darwin-arm64/inklip-base" ]; then
              echo "::error::inklip-base (darwin-arm64) not found!"
              exit 1
            fi
            cp inklip-base-go/dist/darwin-arm64/inklip-base resources/${{ matrix.platform }}-${{ matrix.arch }}/inklip-base/
            chmod +x resources/${{ matrix.platform }}-${{ matrix.arch }}/inklip-base/inklip-base
            echo "âœ… inklip-base (darwin-arm64) å·²å¤åˆ¶åˆ° resources/${{ matrix.platform }}-${{ matrix.arch }}/inklip-base/"
          fi

      - name: Copy gojieba dict to resources
        shell: bash
        run: |
          JIEBA_DIR=$(cd inklip-base-go && go list -m -f '{{.Dir}}' github.com/yanyiwu/gojieba)
          DICT_SRC="${JIEBA_DIR}/deps/cppjieba/dict"
          DICT_DST="resources/${{ matrix.platform }}-${{ matrix.arch }}/jieba-dict"
          mkdir -p "$DICT_DST"
          cp "${DICT_SRC}/jieba.dict.utf8" "${DICT_SRC}/hmm_model.utf8" "${DICT_SRC}/user.dict.utf8" "${DICT_SRC}/idf.utf8" "${DICT_SRC}/stop_words.utf8" "$DICT_DST/"
          echo "âœ… gojieba è¯å…¸å·²å¤åˆ¶åˆ° $DICT_DST"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 25
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build Electron App
        shell: bash
        run: |
          export TARGET_ARCH=${{ matrix.arch }}
          pnpm build
          npx electron-forge make --arch ${{ matrix.arch }}
        env:
          TARGET_ARCH: ${{ matrix.arch }}

      - name: List build output (debug)
        shell: bash
        run: |
          echo "=== Build output structure ==="
          find out -type f -name "*.zip" || echo "No artifacts found"
          echo "=== Complete out/ directory ==="
          ls -R out/ || echo "out/ directory is empty"

      - name: Collect Build Artifacts
        shell: bash
        run: |
          mkdir -p collected-artifacts
          
          # æŸ¥æ‰¾æ‰€æœ‰æž„å»ºäº§ç‰©
          if [ "${{ matrix.platform }}" = "darwin" ]; then
            # macOS: æŸ¥æ‰¾ ZIP æ–‡ä»¶ (Electron Forge MakerZIP è¾“å‡º)
            find out/make -type f -name "*.zip" -exec cp {} collected-artifacts/ \;
          elif [ "${{ matrix.platform }}" = "win32" ]; then
            # Windows: æŸ¥æ‰¾ ZIP, MSI å’Œ EXE æ–‡ä»¶
            find out/make -type f \( -name "*.zip" -o -name "*.msi" -o -name "*.exe" \) -exec cp {} collected-artifacts/ \;
          fi
          
          # éªŒè¯æ˜¯å¦æ”¶é›†åˆ°æ–‡ä»¶
          if [ ! "$(ls -A collected-artifacts 2>/dev/null)" ]; then
            echo "::error::No build artifacts collected!"
            echo "Expected artifacts in out/make directory"
            ls -R out/
            exit 1
          fi
          
          echo "=== Collected artifacts ==="
          ls -lh collected-artifacts/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}-${{ matrix.arch }}
          path: collected-artifacts/*
          if-no-files-found: error
          retention-days: 7

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts (debug)
        run: |
          echo "=== Downloaded artifacts ==="
          ls -R artifacts/

      - name: Prepare Release Files
        run: |
          mkdir -p release-files
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # éåŽ†æ‰€æœ‰ä¸‹è½½çš„ artifact ç›®å½•
          for artifact_dir in artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              # ä»Žç›®å½•åæå–å¹³å°å’Œæž¶æž„ä¿¡æ¯
              # ä¾‹å¦‚: build-darwin-arm64 -> darwin-arm64
              platform_arch=$(basename "$artifact_dir" | sed 's/^build-//')
              
              # å¤åˆ¶æ‰€æœ‰ ZIP æ–‡ä»¶å¹¶é‡å‘½å
              for file in "$artifact_dir"*.zip; do
                if [ -f "$file" ]; then
                  new_filename="Inklip-${VERSION}-${platform_arch}.zip"
                  cp "$file" "release-files/$new_filename"
                  echo "Prepared: $new_filename"
                fi
              done
              
              # å¤åˆ¶æ‰€æœ‰ MSI æ–‡ä»¶å¹¶é‡å‘½å (Windows å¹³å°)
              for file in "$artifact_dir"*.msi; do
                if [ -f "$file" ]; then
                  new_filename="Inklip-${VERSION}-${platform_arch}.msi"
                  cp "$file" "release-files/$new_filename"
                  echo "Prepared: $new_filename"
                fi
              done

              # å¤åˆ¶æ‰€æœ‰ EXE æ–‡ä»¶å¹¶é‡å‘½å (Windows å¹³å°)
              for file in "$artifact_dir"*.exe; do
                if [ -f "$file" ]; then
                  # EXE æ–‡ä»¶é€šå¸¸æ˜¯ setup.exeï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯ "Inklip Setup.exe"
                  # æˆ‘ä»¬ç»Ÿä¸€å‘½åä¸º Inklip-{version}-{arch}.exe
                  # æˆ–è€…ä¿ç•™åŽŸæ¥çš„åå­—ï¼Œè¿™é‡Œé€‰æ‹©ç»Ÿä¸€æ ¼å¼ä»¥ä¿æŒä¸€è‡´æ€§
                  new_filename="Inklip-${VERSION}-${platform_arch}.exe"
                  cp "$file" "release-files/$new_filename"
                  echo "Prepared: $new_filename"
                fi
              done
            fi
          done
          
          # éªŒè¯æ˜¯å¦æœ‰æ–‡ä»¶å‡†å¤‡ä¸Šä¼ 
          if [ -z "$(ls -A release-files 2>/dev/null)" ]; then
            echo "::error::No release files prepared!"
            exit 1
          fi
          
          echo "=== Release files ==="
          ls -lh release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}