name: Build/Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    permissions:
      contents: write
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win32
            arch: x64
            python_platform: win
          - os: macos-latest # ARM64
            platform: darwin
            arch: arm64
            python_platform: mac
          - os: macos-15-intel # Intel x64 (macos-15-intel 可能不存在)
            platform: darwin
            arch: x64
            python_platform: mac

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
      
      - name: Checkout Python Backend
        uses: actions/checkout@v4
        with:
          repository: caleb-meteor/inklip-base
          token: ${{ secrets.GH_PAT }}
          path: inklip-base

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Python dependencies
        run: |
          cd inklip-base
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Python Backend with PyInstaller
        run: |
          cd inklip-base
          pyinstaller --onedir --name inklip_base main.py

      - name: Download and extract platform resources
        shell: bash
        run: |
          mkdir -p resources/${{ matrix.platform }}-${{ matrix.arch }}
          curl -L https://oss-inklip.caleb.center/resources/${{ matrix.platform }}-${{ matrix.arch }}.zip -o resources.zip
          unzip -o resources.zip -d resources/${{ matrix.platform }}-${{ matrix.arch }}
          rm resources.zip

      - name: Move Python Backend to Resources
        shell: bash
        run: |
          cp -r inklip-base/dist/inklip_base resources/${{ matrix.platform }}-${{ matrix.arch }}/

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 25
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build Electron App
        shell: bash
        run: |
          export TARGET_ARCH=${{ matrix.arch }}
          pnpm build
          npx electron-forge make --arch ${{ matrix.arch }}
        env:
          TARGET_ARCH: ${{ matrix.arch }}

      - name: List build output (debug)
        shell: bash
        run: |
          echo "=== Build output structure ==="
          find out -type f -name "*.zip" || echo "No artifacts found"
          echo "=== Complete out/ directory ==="
          ls -R out/ || echo "out/ directory is empty"

      - name: Collect Build Artifacts
        shell: bash
        run: |
          mkdir -p collected-artifacts
          
          # 查找所有构建产物
          if [ "${{ matrix.platform }}" = "darwin" ]; then
            # macOS: 查找 ZIP 文件 (Electron Forge MakerZIP 输出)
            find out/make -type f -name "*.zip" -exec cp {} collected-artifacts/ \;
          elif [ "${{ matrix.platform }}" = "win32" ]; then
            # Windows: 查找 ZIP 文件
            find out/make -type f -name "*.zip" -exec cp {} collected-artifacts/ \;
          fi
          
          # 验证是否收集到文件
          if [ ! "$(ls -A collected-artifacts 2>/dev/null)" ]; then
            echo "::error::No build artifacts collected!"
            echo "Expected artifacts in out/make directory"
            ls -R out/
            exit 1
          fi
          
          echo "=== Collected artifacts ==="
          ls -lh collected-artifacts/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}-${{ matrix.arch }}
          path: collected-artifacts/*
          if-no-files-found: error
          retention-days: 7

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts (debug)
        run: |
          echo "=== Downloaded artifacts ==="
          ls -R artifacts/

      - name: Prepare Release Files
        run: |
          mkdir -p release-files
          VERSION=${GITHUB_REF#refs/tags/v}
          
          # 遍历所有下载的 artifact 目录
          for artifact_dir in artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              # 从目录名提取平台和架构信息
              # 例如: build-darwin-arm64 -> darwin-arm64
              platform_arch=$(basename "$artifact_dir" | sed 's/^build-//')
              
              # 复制所有 ZIP 文件并重命名
              for file in "$artifact_dir"*.zip; do
                if [ -f "$file" ]; then
                  new_filename="Inklip-${VERSION}-${platform_arch}.zip"
                  cp "$file" "release-files/$new_filename"
                  echo "Prepared: $new_filename"
                fi
              done
            fi
          done
          
          # 验证是否有文件准备上传
          if [ -z "$(ls -A release-files 2>/dev/null)" ]; then
            echo "::error::No release files prepared!"
            exit 1
          fi
          
          echo "=== Release files ==="
          ls -lh release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/*
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}